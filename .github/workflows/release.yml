name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build release artifacts
        shell: bash
        run: |
          set -euo pipefail
          version="${GITHUB_REF_NAME}"
          mkdir -p dist

          for os in linux darwin windows; do
            for arch in amd64 arm64; do
              work_dir="dist/${os}_${arch}"
              mkdir -p "$work_dir"

              bin_name="botx"
              if [ "$os" = "windows" ]; then
                bin_name="botx.exe"
              fi

              CGO_ENABLED=0 GOOS="$os" GOARCH="$arch" \
                go build -trimpath -ldflags "-s -w -X main.version=${version}" \
                -o "$work_dir/$bin_name" ./cmd/botx

              if [ "$os" = "windows" ]; then
                archive="botx_${version}_${os}_${arch}.zip"
                (cd "$work_dir" && zip -q "../$archive" "$bin_name")
              else
                archive="botx_${version}_${os}_${arch}.tar.gz"
                tar -C "$work_dir" -czf "dist/$archive" "$bin_name"
              fi

              rm -rf "$work_dir"
            done
          done

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/*
          generate_release_notes: true
